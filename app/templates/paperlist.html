{% extends 'base.html' %}

{% block head %}

<script>
    $(function () {
        var example1 = new Vue({
            el: '#pl',
            delimiters: ["<%", "%>"],
            data: {
                ready: true,
                title: "Coming Soon...",
                comment: "Please wait for several seconds to see today's highlight only for you",
                items: [],
                keyword: "{{ keyword }}",
                date: "{{date}}",
                page: "{{page}}",
                pageobj: {}

            },
            methods: {
                favorite: function (index, event) {
                    console.log("favorite function is clicked");
                    event.preventDefault();
                    var self = this;
                    var favaddquery = $.ajax({
                            url: "/api/favorites/switch",
                            data: JSON.stringify({id: [this.items[index]['pid']]}),
                            type: "POST",
                            dataType: "json",
                            contentType: "application/json"
                        });
                    if (this.items[index].favorite===0){
                        var newitem = this.items[index];
                        newitem.favstyle = {color: 'red'};
                        newitem.favorite = 1;
                        Vue.set(this.items, index, newitem);
                    }
                    else{
                        var newitem = this.items[index];
                        newitem.favstyle = {color: 'black'};
                        newitem.favorite = 0;
                        Vue.set(this.items, index, newitem);
                    }



                }
            },
            created: function () {
                var self = this;
                {% if favlist %}
                var url = "/api/favorites?"+$.param({page: this.page});
                {% else %}
                var url = "/api/today?" + $.param({keyword: this.keyword, date: this.date, page: this.page});
                {% endif %}
                var jsdt = $.getJSON(url);
                jsdt.done(function (data) {
                    self.items = data.results.items;
                    self.pageobj.page = self.page;
                    self.pageobj.hasprev = data.results['has_prev'];
                    self.pageobj.hasnext = data.results['has_next'];
                    // if(self.pageobj.hasnext){console.log("true for next")};
                    if (self.items.length > 0) {
                        self.ready = false;
                        var pid_list = [];
                        for (let i = 0; i < self.items.length; i++) {
                            pid_list.push(self.items[i].pid);

                        }
                    self.$nextTick(function(){
                        if(window.MathJax) {
                            console.log('rendering mathjax');
                            window.MathJax.Hub.Queue(["Typeset", window.MathJax.Hub]);
                        }
                    });

                        {% if current_user.is_authenticated %}
                        var favquery = $.ajax({
                            url: "/api/favorites",
                            data: JSON.stringify({id: pid_list}),
                            type: "POST",
                            dataType: "json",
                            contentType: "application/json"
                        });
                        favquery.done(function (data) {
                            for (let i = 0; i < self.items.length; i++) {
                                self.items[i].favorite = data.results[i];
                                if (self.items[i].favorite === 1) {
                                    var newitem = self.items[i];
                                    newitem.favstyle = {color: 'red'};
                                    Vue.set(self.items, i, newitem);
                                }
                                else {
                                    var newitem = self.items[i];
                                    newitem.favstyle = {color: 'black'};
                                    Vue.set(self.items, i, newitem);
                                }

                            }
                        });
                        favquery.fail(function () {
                            console.log("something went wrong");
                        })
                        {% endif %}
                    }
                    else {
                        self.title = "No paper here";
                        {% if favlist %}
                        self.comment = "You have no favorite paper yet.";
                        {% else %}
                        self.comment = "Maybe you want to add more keywords and fileds of your interest.";
                        {% endif %}
                    }
                });


            }
        })
    });

</script>
{% endblock %}


{% block content %}

<div class="paper-box" id="pl">
    <div v-if="ready" class="uk-card uk-card-default uk-card-body">
        <h3 class="uk-card-title" v-text="title"></h3>
        <p v-text="comment"></p>
    </div>

    <ul class="uk-list uk-list-large uk-list-striped">
        <li v-for="(item, index) in items">
            <h3 class="uk-heading-bullet"><a class="uk-margin-right" :href="'/paper/'+item['arxiv_id']">
                <% item['arxiv_id'] %>
            </a>
                <a uk-icon="heart" v-bind:style="item.favstyle" v-on:click="favorite(index, $event)"></a></h3>
            <template v-for="k in item['keyword']">
                <a class="uk-button uk-button-default" :href='"/?keyword="+k[0]'><% k[0] %></a>
            </template>
            <h3> <% item.title %></h3>
            <div class="uk-margin-top">
                <template v-for="(a, index) in item['authors']">
                    <a href="#"><% a %> </a><span v-if="index+1 < item['authors'].length">,  </span>
                </template>
            </div>

            <p> <% item.summary %></p>
        </li>
    </ul>
    <paginate v-bind="pageobj"></paginate>
</div>
{% endblock %}